<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员仪表盘 - TTS 服务</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js"></script>
    <link rel="stylesheet" href="/admin/css/admin.css">

    <style>
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-top: 30px; }
        .stat-card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; align-items: center; }
        .stat-card .icon { width: 50px; height: 50px; border-radius: 50%; display: flex; justify-content: center; align-items: center; margin-right: 20px; flex-shrink: 0; }
        .stat-card .icon-users { background-color: #eaf2ff; color: #3498db; }
        .stat-card .icon-tokens { background-color: #e8f6f3; color: #2ecc71; }
        .stat-card .icon-frontend { background-color: #e5e7e9; color: #34495e; }
        .stat-card .icon-today-frontend { background-color: #fdebd0; color: #e67e22; }
        .stat-card .icon-total { background-color: #f4ecf7; color: #9b59b6; }
        .stat-card .icon-today { background-color: #fef5e7; color: #f39c12; }
        .stat-card h3 { margin: 0; font-size: 14px; color: #7f8c8d; font-weight: 500; }
        .stat-card .stat-number { font-size: 28px; font-weight: 600; color: #2c3e50; }
        .dashboard-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 30px; }
        .chart-container { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); position: relative; height: 40vh; min-height: 300px; }
        .widget { background: #fff; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .widget h3 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .widget ul { list-style: none; padding: 0; margin: 0; }
        .widget ul li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f9f9f9; }
        .widget ul li:last-child { border-bottom: none; }
        .widget ul li .name { color: #34495e; }
        .widget ul li .count { font-weight: bold; background-color: #ecf0f1; padding: 2px 8px; border-radius: 10px; font-size: 12px; }
        .activity-log .time { font-size: 12px; color: #95a5a6; }
    </style>
</head>
<body>
<nav id="sidebar-container" class="sidebar"></nav>

<main class="main-content">
    <header class="header">
        <h1>仪表盘</h1>
        <div id="welcome-message" style="font-weight: 500;"></div>
    </header>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="icon icon-users"><i data-feather="users"></i></div>
            <div><h3>总用户数</h3><p id="total-users" class="stat-number">...</p></div>
        </div>
        <div class="stat-card">
            <div class="icon icon-tokens"><i data-feather="key"></i></div>
            <div><h3>总 Token 数</h3><p id="total-tokens" class="stat-number">...</p></div>
        </div>
        <div class="stat-card">
            <div class="icon icon-frontend"><i data-feather="monitor"></i></div>
            <div><h3>前端总调用</h3><p id="frontend-calls" class="stat-number">...</p></div>
        </div>
        <div class="stat-card">
            <div class="icon icon-today-frontend"><i data-feather="activity"></i></div>
            <div><h3>前端今日调用</h3><p id="today-frontend-calls" class="stat-number">...</p></div>
        </div>
        <div class="stat-card">
            <div class="icon icon-total"><i data-feather="bar-chart-2"></i></div>
            <div><h3>Token 总调用</h3><p id="total-calls" class="stat-number">...</p></div>
        </div>
        <div class="stat-card">
            <div class="icon icon-today"><i data-feather="zap"></i></div>
            <div><h3>Token 今日调用</h3><p id="today-calls" class="stat-number">...</p></div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="chart-container">
            <h3>最近7天 Token 调用趋势</h3>
            <canvas id="api-calls-chart"></canvas>
        </div>
        <div class="widgets-column">
            <div class="widget">
                <h3>热门角色 (按Token调用)</h3>
                <ul id="top-characters-list"></ul>
            </div>
            <div class="widget" style="margin-top: 20px;">
                <h3>近期 Token 活动</h3>
                <ul id="recent-activity-list" class="activity-log"></ul>
            </div>
        </div>
    </div>
</main>

<script src="/admin/js/admin.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        loadSidebar('/admin');

        async function renderDashboard() {
            try {
                const res = await fetch('/api/admin/dashboard-data');
                const data = await res.json();

                document.getElementById('total-users').textContent = data.stats.totalUsers;
                document.getElementById('total-tokens').textContent = data.stats.totalTokens;
                document.getElementById('frontend-calls').textContent = data.stats.frontendCalls;
                document.getElementById('today-frontend-calls').textContent = data.stats.todayFrontendCalls;
                document.getElementById('total-calls').textContent = data.stats.totalCalls;
                document.getElementById('today-calls').textContent = data.stats.todayCalls;

                renderChart(data.chartData);

                const topCharList = document.getElementById('top-characters-list');
                topCharList.innerHTML = '';
                if (data.topCharacters.length > 0) {
                    data.topCharacters.forEach(char => { topCharList.insertAdjacentHTML('beforeend', `<li><span class="name">${char.character_used}</span><span class="count">${char.count} 次</span></li>`); });
                } else { topCharList.innerHTML = '<li><span class="no-data">暂无数据</span></li>'; }

                const recentActivityList = document.getElementById('recent-activity-list');
                recentActivityList.innerHTML = '';
                if (data.recentLogs.length > 0) {
                    data.recentLogs.forEach(log => {
                        const time = new Date(log.request_timestamp + 'Z').toLocaleString('zh-CN', { hour12: false });
                        recentActivityList.insertAdjacentHTML('beforeend', `<li><div><span class="name">${log.owner_name || '未知用户'}</span><div class="time">${time}</div></div><span class="count">${log.token_name}</span></li>`);
                    });
                } else { recentActivityList.innerHTML = '<li><span class="no-data">暂无活动</span></li>'; }

                feather.replace();
            } catch (error) {
                console.error(error);
                document.querySelector('.main-content').innerHTML = '<h1>加载仪表盘数据失败，请刷新页面重试。</h1>';
            }
        }

        function renderChart({ labels, data }) {
            const ctx = document.getElementById('api-calls-chart').getContext('2d');
            new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'API 调用次数', data: data, borderColor: '#3498db', backgroundColor: 'rgba(52, 152, 219, 0.1)', borderWidth: 2, fill: true, tension: 0.3 }] }, options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }, responsive: true, maintainAspectRatio: false } });
        }

        (async () => {
            try {
                const sessionRes = await fetch('/api/session-info');
                const sessionData = await sessionRes.json();
                if (sessionData.loggedIn) {
                    document.getElementById('welcome-message').textContent = `欢迎, ${sessionData.user.name}`;
                }
            } catch(e) { /* do nothing */ }
        })();

        renderDashboard();
    });
</script>
</body>
</html>